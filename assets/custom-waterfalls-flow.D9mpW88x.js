import{M as t,d as s,o as e,c as i,w as a,t as l,v as h,F as n,b as o,n as r,e as d,f as u,r as c,N as m,O as g,h as f,a as p,i as y}from"./index-CQZovXBN.js";import{_}from"./api.BbjEcOtK.js";const x=_({props:{value:Array,column:{type:[String,Number],default:2},maxColumn:{type:[String,Number],default:5},columnSpace:{type:[String,Number],default:2},imageKey:{type:[String],default:"image"},hideImageKey:{type:[String],default:"hide"},seat:{type:[String,Number],default:2},listStyle:{type:Object}},data(){return{data:{list:this.value?this.value:[],column:this.column<2?2:this.column,columnSpace:this.columnSpace<=5?this.columnSpace:5,imageKey:this.imageKey,seat:this.seat},msg:0,listInitStyle:{"border-radius":"12rpx","margin-bottom":"20rpx","background-color":"#fff"},adds:[],isLoaded:!0,curIndex:0,isRefresh:!0,flag:!1,refreshDatas:[]}},computed:{w(){return 100/this.data.column-+this.data.columnSpace+"%"},m(){return(100-(100/this.data.column-+this.data.columnSpace).toFixed(5)*this.data.column)/(this.data.column-1)+"%"},s1(){return{...this.listInitStyle,...this.listStyle}}},created(){this.refresh()},methods:{loadImages(s=0){let e=0;const i=this.data.list.filter(((t,e)=>e>=s));for(let a=0;a<i.length;a++)t({src:`${i[a][this.imageKey]}.jpg`,complete:t=>{e++,e==i.length&&this.initValue(s)}})},refresh(){if(!this.isLoaded)return this.refreshDatas=this.value,!1;setTimeout((()=>{this.refreshDatas=[],this.isRefresh=!0,this.adds=[],this.data.list=this.value?this.value:[],this.data.column=this.column<2?2:this.column>=this.maxColumn?this.maxColumn:this.column,this.data.columnSpace=this.columnSpace<=5?this.columnSpace:5,this.data.imageKey=this.imageKey,this.data.seat=this.seat,this.curIndex=0;for(let t=1;t<=this.data.column;t++)this.data[`column_${t}_values`]=[],this.msg++;this.$nextTick((()=>{this.initValue(this.curIndex,"refresh==>")}))}),1)},columnValue(t){return this.data[`column_${t+1}_values`]},change(t){for(let s=0;s<this.data.list.length;s++){const e=this.data[`column_${this.data.list[s].column}_values`];for(let i=0;i<e.length;i++)if(t[s]&&s===e[i].index){this.data[`column_${this.data.list[s].column}_values`][i]=Object.assign(e[i],t[s]),this.msg++;break}}},getMin(t,s){let e=t[0][s],i=t[0];for(var a=t.length-1;a>=0;a--)t[a][s]<e&&(e=t[a][s]);return i=t.filter((t=>t[s]==e)),i[0]},getMinColumnHeight(){return new Promise((t=>{const e=[];for(let i=1;i<=this.data.column;i++){s().in(this).select(`#waterfalls_flow_column_${i}`).boundingClientRect((t=>{e.push({column:i,height:t.height})})).exec((()=>{this.data.column<=e.length&&t(this.getMin(e,"height"))}))}}))},async initValue(t,s){if(this.isLoaded=!1,t>=this.data.list.length||this.refreshDatas.length)return this.msg++,this.loaded(),!1;const e=await this.getMinColumnHeight(),i=this.data[`column_${e.column}_values`];this.data.list[t].column=e.column,i.push({...this.data.list[t],cIndex:i.length,index:t,o:0}),this.msg++},imgLoad(t,s){const e=t.index;t.o=1,this.$set(this.data[`column_${s}_values`],t.cIndex,JSON.parse(JSON.stringify(t))),this.initValue(e+1)},imgError(t,s){const e=t.index;t.o=1,t[this.data.imageKey]=null,this.$set(this.data[`column_${s}_values`],t.cIndex,JSON.parse(JSON.stringify(t))),this.initValue(e+1)},loaded(){if(this.refreshDatas.length)return this.isLoaded=!0,this.refresh(),!1;this.curIndex=this.data.list.length,this.adds.length?(this.data.list=this.adds[0],this.adds.splice(0,1),this.initValue(this.curIndex)):(this.data.list.length&&this.$emit("loaded"),this.isLoaded=!0,this.isRefresh=!1)},wapperClick(t){this.$emit("wapperClick",t)},imageClick(t){this.$emit("imageClick",t)}},watch:{value:{deep:!0,handler(t,s){setTimeout((()=>{this.$nextTick((()=>{if(this.isRefresh)return!1;if(this.isLoaded){if(t.length<=this.curIndex)return this.change(t);this.data.list=t,this.$nextTick((()=>{this.initValue(this.curIndex,"watch==>")}))}else this.adds.push(t)}))}),10)}},column(t){this.refresh()}}},[["render",function(t,s,_,x,S,v){const w=o,$=y;return e(),i(w,{class:"waterfalls-flow"},{default:a((()=>[(e(!0),l(n,null,h(S.data.column,((s,o)=>(e(),i(w,{key:o,class:"waterfalls-flow-column",id:`waterfalls_flow_column_${o+1}`,msg:S.msg,style:r({width:v.w,"margin-left":0==o?0:v.m})},{default:a((()=>[(e(!0),l(n,null,h(v.columnValue(o),((s,l)=>(e(),i(w,{class:d(["column-value",{"column-value-show":s.o}]),key:l,style:r([v.s1]),onClick:u((t=>v.wapperClick(s)),["stop"])},{default:a((()=>[1==S.data.seat?(e(),i(w,{key:0,class:"inner"},{default:a((()=>[c(t.$slots,"default",m(g(s)),void 0,!0)])),_:2},1024)):f("",!0),p($,{class:d(["img",{"img-hide":1==s[_.hideImageKey]||1==s[_.hideImageKey]},{"img-error":!s[S.data.imageKey]}]),src:s[S.data.imageKey],mode:"widthFix",onLoad:t=>v.imgLoad(s,o+1),onError:t=>v.imgError(s,o+1),onClick:u((t=>v.imageClick(s)),["stop"])},null,8,["class","src","onLoad","onError","onClick"]),2==S.data.seat?(e(),i(w,{key:1,class:"inner"},{default:a((()=>[c(t.$slots,"default",m(g(s)),void 0,!0)])),_:2},1024)):f("",!0)])),_:2},1032,["class","style","onClick"])))),128))])),_:2},1032,["id","msg","style"])))),128))])),_:3})}],["__scopeId","data-v-bab6f353"]]);export{x as _};
